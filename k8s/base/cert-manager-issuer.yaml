# ============================================
# CERT-MANAGER - AUTOMATIC SSL CERTIFICATES
# ============================================
#
# WHAT IS CERT-MANAGER?
# - Automates SSL/TLS certificate management
# - Integrates with Let's Encrypt (free SSL certificates)
# - Automatically renews certificates before expiry
# - No manual certificate creation needed
#
# WHY USE IT?
# - Manual certificates expire and need renewal
# - Let's Encrypt is free and trusted by all browsers
# - Automatic renewal prevents downtime from expired certs
#
# PREREQUISITES:
# Install cert-manager (one-time, cluster-wide):
# kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# ============================================

---
# ClusterIssuer - Let's Encrypt STAGING (for testing)
# Use this first to test your setup without hitting rate limits
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    # Let's Encrypt staging server (for testing)
    server: https://acme-staging-v02.api.letsencrypt.org/directory

    # Email for certificate expiry notifications
    email: admin@yourdomain.com  # REPLACE with your email

    # Secret to store ACME account private key
    privateKeySecretRef:
      name: letsencrypt-staging

    # HTTP-01 challenge (proves you own the domain)
    solvers:
    - http01:
        ingress:
          class: nginx

---
# ClusterIssuer - Let's Encrypt PRODUCTION
# Use this after testing with staging issuer
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # Let's Encrypt production server
    server: https://acme-v02.api.letsencrypt.org/directory

    # IMPORTANT: Email is required for expiry notifications
    email: admin@yourdomain.com  # REPLACE with your email

    privateKeySecretRef:
      name: letsencrypt-prod

    solvers:
    - http01:
        ingress:
          class: nginx

---
# USAGE INSTRUCTIONS:
#
# 1. INSTALL CERT-MANAGER (one-time):
#    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
#    # Verify installation
#    kubectl get pods -n cert-manager
#
# 2. UPDATE EMAIL ADDRESS:
#    Edit this file and replace "admin@yourdomain.com" with your actual email
#
# 3. APPLY CLUSTERISSUERS:
#    kubectl apply -f cert-manager-issuer.yaml
#
# 4. UPDATE INGRESS TO USE CERT-MANAGER:
#    In ingress.yaml, add this annotation:
#    cert-manager.io/cluster-issuer: "letsencrypt-staging"  # For testing
#    # or
#    cert-manager.io/cluster-issuer: "letsencrypt-prod"  # For production
#
# 5. APPLY INGRESS:
#    kubectl apply -f ingress.yaml
#
# 6. VERIFY CERTIFICATE:
#    # Check certificate status
#    kubectl get certificate -n credit-enforcement
#
#    # Check certificate details
#    kubectl describe certificate credit-enforcement-tls -n credit-enforcement
#
#    # Certificate should show "Ready: True" within 2-5 minutes
#
# 7. TEST STAGING CERTIFICATE:
#    curl -k https://api.yourdomain.com
#    # Staging certs show as "untrusted" - this is expected
#
# 8. SWITCH TO PRODUCTION:
#    # Update ingress annotation to use letsencrypt-prod
#    # Delete old certificate
#    kubectl delete certificate credit-enforcement-tls -n credit-enforcement
#    # Reapply ingress
#    kubectl apply -f ingress.yaml
#
# NOTES:
#
# 1. RATE LIMITS:
#    - Staging: No rate limits (use for testing)
#    - Production: 50 certificates per domain per week
#    - Always test with staging first!
#
# 2. DNS MUST BE CONFIGURED:
#    - Domain must resolve to ingress LoadBalancer IP
#    - Let's Encrypt validates by making HTTP request to your domain
#    - If DNS not configured, certificate issuance fails
#
# 3. HTTP-01 CHALLENGE:
#    - Let's Encrypt creates temporary path: /.well-known/acme-challenge/
#    - Must be accessible via HTTP (redirects to HTTPS disabled during challenge)
#    - Ingress controller automatically handles this
#
# 4. TROUBLESHOOTING:
#    # Check cert-manager logs
#    kubectl logs -n cert-manager deployment/cert-manager
#
#    # Check challenge status
#    kubectl get challenge -n credit-enforcement
#
#    # Check order status
#    kubectl get order -n credit-enforcement
#
# 5. CERTIFICATE RENEWAL:
#    - Automatic renewal 30 days before expiry
#    - No manual intervention needed
#    - Monitor with: kubectl get certificate -n credit-enforcement