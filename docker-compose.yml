services:
  redis:
    image: redis:7.2-alpine
    container_name: redis_cache
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - backend-net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 10
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  eureka-server:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     SERVICE_NAME: eureka-server
    image: qvwy18uw.c1.de1.container-registry.ovh.net/fincolreg/eureka-server:1.0.0
    container_name: eureka-server
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8761/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=${SERVER_PORT_EUREKA:-8761}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_EUREKA=${LOGGING_LEVEL_EUREKA:-DEBUG}
      - LOGGING_LEVEL_DISCOVERY=${LOGGING_LEVEL_DISCOVERY:-DEBUG}
    networks:
      - backend-net

  access-management-service:
    # build:
    #   # context: .
    #   # dockerfile: Dockerfile
    #   args:
    #     SERVICE_NAME: access-management-service
    image: qvwy18uw.c1.de1.container-registry.ovh.net/fincolreg/access-management-service:2.0.0
    container_name: access-management-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=${SERVER_PORT_ACCESS_MGMT:-8081}
      - EUREKA_SERVER_URL=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_HOSTNAME=access-management-service
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=${EUREKA_INSTANCE_PREFER_IP_ADDRESS:-false}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-3600000}
      - JWT_ISSUER=${JWT_ISSUER:-finxbridge}
      - JWT_REFRESH_TOKEN_EXPIRY=${JWT_REFRESH_TOKEN_EXPIRY:-604800000}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-staging_db}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=redis_cache
      - REDIS_PORT=${REDIS_PORT:-6379}
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - FLYWAY_BASELINE_ON_MIGRATE=${FLYWAY_BASELINE_ON_MIGRATE:-true}
      - FLYWAY_OUT_OF_ORDER=${FLYWAY_OUT_OF_ORDER:-false}
      - FLYWAY_VALIDATE_ON_MIGRATE=${FLYWAY_VALIDATE_ON_MIGRATE:-false}
      - FLYWAY_CLEAN_DISABLED=${FLYWAY_CLEAN_DISABLED:-true}
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      eureka-server:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend-net

  communication-service:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     SERVICE_NAME: communication-service
    image: qvwy18uw.c1.de1.container-registry.ovh.net/fincolreg/communication-service:1.0.0
    container_name: communication-service
    ports:
      - "8084:8084"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=${SERVER_PORT_COMMUNICATION:-8084}
      - EUREKA_SERVER_URL=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_HOSTNAME=communication-service
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=${EUREKA_INSTANCE_PREFER_IP_ADDRESS:-false}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-3600000}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-staging_db}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=redis_cache
      - REDIS_PORT=${REDIS_PORT:-6379}
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - FLYWAY_BASELINE_ON_MIGRATE=${FLYWAY_BASELINE_ON_MIGRATE:-true}
      - FLYWAY_OUT_OF_ORDER=${FLYWAY_OUT_OF_ORDER:-false}
      - FLYWAY_VALIDATE_ON_MIGRATE=${FLYWAY_VALIDATE_ON_MIGRATE:-false}
      - FLYWAY_CLEAN_DISABLED=${FLYWAY_CLEAN_DISABLED:-true}
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      eureka-server:
        condition: service_healthy
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  master-data-service:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     SERVICE_NAME: master-data-service
    image: qvwy18uw.c1.de1.container-registry.ovh.net/fincolreg/master-data-service:1.0.0
    container_name: master-data-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8085/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8085:8085"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=${SERVER_PORT_MASTER_DATA:-8085}
      - EUREKA_SERVER_URL=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_HOSTNAME=master-data-service
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=${EUREKA_INSTANCE_PREFER_IP_ADDRESS:-false}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-staging_db}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=redis_cache
      - REDIS_PORT=${REDIS_PORT:-6379}
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - FLYWAY_BASELINE_ON_MIGRATE=${FLYWAY_BASELINE_ON_MIGRATE:-true}
      - FLYWAY_OUT_OF_ORDER=${FLYWAY_OUT_OF_ORDER:-false}
      - FLYWAY_VALIDATE_ON_MIGRATE=${FLYWAY_VALIDATE_ON_MIGRATE:-false}
      - FLYWAY_CLEAN_DISABLED=${FLYWAY_CLEAN_DISABLED:-true}
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      eureka-server:
        condition: service_healthy
      redis:
        condition: service_healthy
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  case-sourcing-service:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     SERVICE_NAME: case-sourcing-service
    image: qvwy18uw.c1.de1.container-registry.ovh.net/fincolreg/case-sourcing-service:1.0.0
    container_name: case-sourcing-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8082/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=${SERVER_PORT_CASE_SOURCING:-8082}
      - EUREKA_SERVER_URL=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_HOSTNAME=case-sourcing-service
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=${EUREKA_INSTANCE_PREFER_IP_ADDRESS:-false}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-staging_db}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=redis_cache
      - REDIS_PORT=${REDIS_PORT:-6379}
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - FLYWAY_BASELINE_ON_MIGRATE=${FLYWAY_BASELINE_ON_MIGRATE:-true}
      - FLYWAY_OUT_OF_ORDER=${FLYWAY_OUT_OF_ORDER:-false}
      - FLYWAY_VALIDATE_ON_MIGRATE=${FLYWAY_VALIDATE_ON_MIGRATE:-false}
      - FLYWAY_CLEAN_DISABLED=${FLYWAY_CLEAN_DISABLED:-true}
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      eureka-server:
        condition: service_healthy
      redis:
        condition: service_healthy
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  allocation-reallocation-service:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     SERVICE_NAME: allocation-reallocation-service
    image: qvwy18uw.c1.de1.container-registry.ovh.net/fincolreg/allocation-reallocation-service:1.0.0
    container_name: allocation-reallocation-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8083/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=${SERVER_PORT_ALLOCATION:-8083}
      - EUREKA_SERVER_URL=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_HOSTNAME=allocation-reallocation-service
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=${EUREKA_INSTANCE_PREFER_IP_ADDRESS:-false}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-staging_db}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=redis_cache
      - REDIS_PORT=${REDIS_PORT:-6379}
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - FLYWAY_BASELINE_ON_MIGRATE=${FLYWAY_BASELINE_ON_MIGRATE:-true}
      - FLYWAY_OUT_OF_ORDER=${FLYWAY_OUT_OF_ORDER:-false}
      - FLYWAY_VALIDATE_ON_MIGRATE=${FLYWAY_VALIDATE_ON_MIGRATE:-false}
      - FLYWAY_CLEAN_DISABLED=${FLYWAY_CLEAN_DISABLED:-true}
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      eureka-server:
        condition: service_healthy
      redis:
        condition: service_healthy
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  api-gateway:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     SERVICE_NAME: api-gateway
    image: qvwy18uw.c1.de1.container-registry.ovh.net/fincolreg/api-gateway:1.0.0
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=${SERVER_PORT_API_GATEWAY:-8080}
      - EUREKA_SERVER_URL=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_HOSTNAME=api-gateway
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=${EUREKA_INSTANCE_PREFER_IP_ADDRESS:-false}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8080}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-staging_db}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=redis_cache
      - REDIS_PORT=${REDIS_PORT:-6379}
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - FLYWAY_BASELINE_ON_MIGRATE=${FLYWAY_BASELINE_ON_MIGRATE:-true}
      - FLYWAY_OUT_OF_ORDER=${FLYWAY_OUT_OF_ORDER:-false}
      - FLYWAY_VALIDATE_ON_MIGRATE=${FLYWAY_VALIDATE_ON_MIGRATE:-false}
      - FLYWAY_CLEAN_DISABLED=${FLYWAY_CLEAN_DISABLED:-true}
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-3600000}
      - CIRCUIT_BREAKER_HEALTH_INDICATOR=${CIRCUIT_BREAKER_HEALTH_INDICATOR:-true}
      - CIRCUIT_BREAKER_SLIDING_WINDOW_SIZE=${CIRCUIT_BREAKER_SLIDING_WINDOW_SIZE:-10}
      - CIRCUIT_BREAKER_FAILURE_RATE_THRESHOLD=${CIRCUIT_BREAKER_FAILURE_RATE_THRESHOLD:-50}
      - CIRCUIT_BREAKER_WAIT_DURATION=${CIRCUIT_BREAKER_WAIT_DURATION:-5s}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - backend-net

networks:
  backend-net:
    driver: bridge

volumes:
  redis_data:
