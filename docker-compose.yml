services:
  access-management-service:
    build:
      context: .
      dockerfile: access-management-service/Dockerfile
    container_name: access-management-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=8081
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-3600000}
      - JWT_ISSUER=${JWT_ISSUER:-finxbridge}
      - JWT_REFRESH_TOKEN_EXPIRY=${JWT_REFRESH_TOKEN_EXPIRY:-604800000}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-development_db}?sslmode=${POSTGRES_SSL_MODE:-disable}&connectTimeout=${POSTGRES_CONNECT_TIMEOUT:-30}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=${REDIS_SSL_ENABLED:-false}
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - FLYWAY_BASELINE_ON_MIGRATE=${FLYWAY_BASELINE_ON_MIGRATE:-true}
      - FLYWAY_OUT_OF_ORDER=${FLYWAY_OUT_OF_ORDER:-false}
      - FLYWAY_VALIDATE_ON_MIGRATE=${FLYWAY_VALIDATE_ON_MIGRATE:-false}
      - FLYWAY_CLEAN_DISABLED=${FLYWAY_CLEAN_DISABLED:-true}
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
      - COMMUNICATION_SERVICE_URL=http://communication-service:8085
    networks:
      - backend-net

  master-data-service:
    build:
      context: .
      dockerfile: master-data-service/Dockerfile
    container_name: master-data-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8082/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=8082
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-development_db}?sslmode=${POSTGRES_SSL_MODE:-disable}&connectTimeout=${POSTGRES_CONNECT_TIMEOUT:-30}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=${REDIS_SSL_ENABLED:-false}
      - FLYWAY_ENABLED=false
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  case-sourcing-service:
    build:
      context: .
      dockerfile: case-sourcing-service/Dockerfile
    container_name: case-sourcing-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8083/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=8083
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-development_db}?sslmode=${POSTGRES_SSL_MODE:-disable}&connectTimeout=${POSTGRES_CONNECT_TIMEOUT:-30}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=${REDIS_SSL_ENABLED:-false}
      - FLYWAY_ENABLED=false
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  allocation-reallocation-service:
    build:
      context: .
      dockerfile: allocation-reallocation-service/Dockerfile
    container_name: allocation-reallocation-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8084/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8084:8084"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=8084
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-development_db}?sslmode=${POSTGRES_SSL_MODE:-disable}&connectTimeout=${POSTGRES_CONNECT_TIMEOUT:-30}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=${REDIS_SSL_ENABLED:-false}
      - FLYWAY_ENABLED=false
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  communication-service:
    build:
      context: .
      dockerfile: communication-service/Dockerfile
    container_name: communication-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8085/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8085:8085"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=8085
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-3600000}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-development_db}?sslmode=${POSTGRES_SSL_MODE:-disable}&connectTimeout=${POSTGRES_CONNECT_TIMEOUT:-30}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=${REDIS_SSL_ENABLED:-false}
      - FLYWAY_ENABLED=false
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
    depends_on:
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  strategy-engine-service:
    build:
      context: .
      dockerfile: strategy-engine-service/Dockerfile
    container_name: strategy-engine-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8086/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8086:8086"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=8086
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-development_db}?sslmode=${POSTGRES_SSL_MODE:-disable}&connectTimeout=${POSTGRES_CONNECT_TIMEOUT:-30}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=${REDIS_SSL_ENABLED:-false}
      - FLYWAY_ENABLED=false
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
      - COMMUNICATION_SERVICE_URL=http://communication-service:8085
      - TEMPLATE_SERVICE_URL=http://template-management-service:8087
    depends_on:
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  template-management-service:
    build:
      context: .
      dockerfile: template-management-service/Dockerfile
    container_name: template-management-service
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8087/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8087:8087"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=8087
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-development_db}?sslmode=${POSTGRES_SSL_MODE:-disable}&connectTimeout=${POSTGRES_CONNECT_TIMEOUT:-30}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=${REDIS_SSL_ENABLED:-false}
      - FLYWAY_ENABLED=false
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
      - COMMUNICATION_SERVICE_URL=http://communication-service:8085
      - DMS_SERVICE_URL=http://dms-service:8093
    depends_on:
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - SERVER_PORT=8080
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8080}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${POSTGRES_HOST:-host.docker.internal}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-development_db}?sslmode=${POSTGRES_SSL_MODE:-disable}&connectTimeout=${POSTGRES_CONNECT_TIMEOUT:-30}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-admin}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-password}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=${REDIS_SSL_ENABLED:-false}
      - FLYWAY_ENABLED=false
      - JPA_DDL_AUTO=${JPA_DDL_AUTO:-validate}
      - JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}
      - JPA_FORMAT_SQL=${JPA_FORMAT_SQL:-false}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-3600000}
      - CIRCUIT_BREAKER_HEALTH_INDICATOR=${CIRCUIT_BREAKER_HEALTH_INDICATOR:-true}
      - CIRCUIT_BREAKER_SLIDING_WINDOW_SIZE=${CIRCUIT_BREAKER_SLIDING_WINDOW_SIZE:-10}
      - CIRCUIT_BREAKER_FAILURE_RATE_THRESHOLD=${CIRCUIT_BREAKER_FAILURE_RATE_THRESHOLD:-50}
      - CIRCUIT_BREAKER_WAIT_DURATION=${CIRCUIT_BREAKER_WAIT_DURATION:-5s}
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-INFO}
      - LOGGING_LEVEL_FINX=${LOGGING_LEVEL_FINX:-DEBUG}
      - ACCESS_MANAGEMENT_SERVICE_URL=http://access-management-service:8081
      - MASTER_DATA_SERVICE_URL=http://master-data-service:8082
      - CASE_SOURCING_SERVICE_URL=http://case-sourcing-service:8083
      - ALLOCATION_REALLOCATION_SERVICE_URL=http://allocation-reallocation-service:8084
      - COMMUNICATION_SERVICE_URL=http://communication-service:8085
      - STRATEGY_ENGINE_SERVICE_URL=http://strategy-engine-service:8086
      - TEMPLATE_MANAGEMENT_SERVICE_URL=http://template-management-service:8087
    depends_on:
      access-management-service:
        condition: service_healthy
    networks:
      - backend-net

networks:
  backend-net:
    driver: bridge
